# $Id$
# vim: syntax=tcl

proc run {project_name} {
	exec sed "s/undef NO_SSL/define NO_SSL/g" config.h.tmpl > config.h
	set ::env(DISPLAY) ":0"
	RunCommand "make clean"
	set dirname ""
	if { "$project_name" == "Tewi-BCC" } {
		set ::env(LANG) "ja_JP.UTF-8"
		set ::env(BORLAND) "C:/borland/bcc55"
		RunCommand "make PLATFORM=bcc"
		set ::env(LANG) "en_US.UTF-8"
		set dirname "bcc"
	} elseif { "$project_name" == "Tewi-VC6" } {
		RunCommand "make PLATFORM=vc6"
		set dirname "vc6"
	} elseif { "$project_name" == "Tewi-Watcom" } {
		set ::env(WATCOM) "/usr/watcom"
		set ::env(INCLUDE) "/usr/watcom/h"
		set ::env(PATH) "$::env(PATH):/usr/watcom/binl64"
		RunCommand "make PLATFORM=watcom"
		set dirname "watcom"
	} else {
		RunCommand "make"
	}
	file mkdir workdir
	file mkdir workdir/etc
	file mkdir workdir/www
	file mkdir workdir/modules
	file delete archive.7z

	exec ./Tool/itworks > workdir/www/index.html
	exec ./Tool/genconf C:/Tewi modules dll > workdir/etc/tewi.conf
	RunCommand "cp Binary/pbtewi.gif workdir/www/"
	foreach filen [glob Module/*.dll] {
		RunCommand "cp $filen workdir/modules/"
	}
	cd workdir
	RunCommand "7z a ../archive.7z *"
	cd ..
	exec cat /usr/share/7z.sfx archive.7z > tewidist.exe
	RunCommand "rm -rf workdir"
	RunCommand "doas mkdir -p /raid/f/g/tewi/$dirname"
	RunCommand "doas cp tewidist.exe /raid/f/g/tewi/$dirname/tewidist$dirname-[exec make get-version]-nossl.exe"
	RunCommand "doas mkdir -p /raid/ftp/pub/tewi/$dirname"
	RunCommand "doas cp tewidist.exe /raid/ftp/pub/tewi/$dirname/tewidist$dirname-[exec make get-version]-nossl.exe"
}
